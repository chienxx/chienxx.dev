---
title: 'ä½¿ç”¨ Docker Compose éƒ¨ç½² Prometheusã€Grafanaï¼šå®ç°æœåŠ¡å™¨ã€Web åº”ç”¨çš„ç›‘æ§ä¸å‘Šè­¦'
date: '2023-08-16'
lastmod: '2025-03-05'
tags: ['prometheus', 'grafana', 'alertmanager', 'monitor']
draft: false
summary: 'åœ¨ç°ä»£çš„è¿ç»´å’Œå¼€å‘ç¯å¢ƒä¸­ï¼Œç›‘æ§ç³»ç»Ÿçš„å¥åº·çŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡æ˜¯è‡³å…³é‡è¦çš„ã€‚é€šè¿‡ç›‘æ§ï¼Œæˆ‘ä»¬å¯ä»¥åŠæ—¶å‘ç°æ½œåœ¨é—®é¢˜ï¼Œé¿å…ç³»ç»Ÿå®•æœºæˆ–æ€§èƒ½ä¸‹é™ã€‚'
layout: PostLayout
images: ['/static/images/banners/prometheus-grafana-monitor-alert.png']
---

## æŠ€æœ¯æ ˆç®€ä»‹

### Prometheus

Prometheus æ˜¯ä¸€ä¸ªå¼€æºçš„ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦å·¥å…·ã€‚å®ƒé€šè¿‡æ‹‰å–ï¼ˆPullï¼‰æ¨¡å¼ä»ç›®æ ‡å®ä¾‹æ”¶é›†æŒ‡æ ‡æ•°æ®ï¼Œå¹¶æ”¯æŒå¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€ PromQLï¼Œç”¨äºåˆ†æå’Œå‘Šè­¦ã€‚Prometheus çš„æ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ï¼š

- **Prometheus Server**ï¼šè´Ÿè´£æ•°æ®é‡‡é›†å’Œå­˜å‚¨ã€‚
- **Exporters**ï¼šç”¨äºä»å„ç§ç³»ç»Ÿå’ŒæœåŠ¡ä¸­æš´éœ²æŒ‡æ ‡æ•°æ®ã€‚
- **Alertmanager**ï¼šè´Ÿè´£å¤„ç†å‘Šè­¦é€šçŸ¥ã€‚

### Grafana

Grafana æ˜¯ä¸€ä¸ªå¼€æºçš„æ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œæ”¯æŒå¤šç§æ•°æ®æºï¼ˆå¦‚ Prometheusã€InfluxDB ç­‰ï¼‰ã€‚å®ƒå¯ä»¥å°†ç›‘æ§æ•°æ®ä»¥å›¾è¡¨çš„å½¢å¼å±•ç¤ºï¼Œå¸®åŠ©ç”¨æˆ·æ›´ç›´è§‚åœ°ç†è§£ç³»ç»ŸçŠ¶æ€ã€‚Grafana çš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

- åˆ›å»ºåŠ¨æ€ä»ªè¡¨ç›˜ã€‚
- æ”¯æŒå¤šç§æ•°æ®æºã€‚
- æä¾›ä¸°å¯Œçš„å¯è§†åŒ–æ’ä»¶ã€‚

### Alertmanager

Alertmanager æ˜¯ Prometheus çš„å‘Šè­¦ç®¡ç†ç»„ä»¶ï¼Œè´Ÿè´£å¤„ç† Prometheus å‘é€çš„å‘Šè­¦ï¼Œå¹¶æ ¹æ®é…ç½®çš„è·¯ç”±è§„åˆ™å‘é€é€šçŸ¥ï¼ˆå¦‚é‚®ä»¶ã€Slack ç­‰ï¼‰ã€‚Alertmanager çš„æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ï¼š

- å‘Šè­¦åˆ†ç»„å’Œå»é‡ã€‚
- æ”¯æŒå¤šç§é€šçŸ¥æ¸ é“ã€‚
- æä¾›é™é»˜å’ŒæŠ‘åˆ¶åŠŸèƒ½ã€‚

### Node Exporter

Node Exporter ç”¨äºæ”¶é›†æœåŠ¡å™¨ä¸»æœºçš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¦‚ CPUã€å†…å­˜ã€ç£ç›˜ç­‰ã€‚å®ƒé€šè¿‡æš´éœ² HTTP æ¥å£ï¼Œå°†ç³»ç»ŸæŒ‡æ ‡æä¾›ç»™ Prometheus é‡‡é›†ã€‚

### Blackbox Exporter

Blackbox Exporter ç”¨äºç›‘æ§å¤–éƒ¨æœåŠ¡çš„å¯ç”¨æ€§ï¼Œå¦‚ HTTP/HTTPSã€TCPã€ICMP ç­‰ã€‚å®ƒé€šè¿‡æ¢é’ˆæœºåˆ¶ï¼Œå®šæœŸæ£€æŸ¥ç›®æ ‡æœåŠ¡çš„å¥åº·çŠ¶æ€ã€‚

## å®ç°ç›®æ ‡

- **ç›‘æ§æœåŠ¡å™¨ä¸»æœº**ï¼šé€šè¿‡ node-exporter æ”¶é›† CPUã€å†…å­˜ã€ç£ç›˜ç­‰æŒ‡æ ‡ã€‚

- **ç›‘æ§ Web åº”ç”¨**ï¼šé€šè¿‡ blackbox_exporter ç›‘æ§ Web åº”ç”¨çš„ HTTP/HTTPS å¯ç”¨æ€§ã€‚

- **å¯è§†åŒ–ç›‘æ§æ•°æ®**ï¼šä½¿ç”¨ Grafana åˆ›å»ºä»ªè¡¨ç›˜ï¼Œå±•ç¤ºæœåŠ¡å™¨ã€Web åº”ç”¨çš„ç›‘æ§æ•°æ®ã€‚

- **å‘Šè­¦é€šçŸ¥**ï¼šé€šè¿‡ Alertmanager é…ç½®å‘Šè­¦è§„åˆ™ï¼Œå½“æœåŠ¡å™¨ã€Web åº”ç”¨å‡ºç°å¼‚å¸¸æ—¶ï¼Œè‡ªåŠ¨å‘é€é‚®ä»¶é€šçŸ¥ã€‚

## éƒ¨ç½²æ­¥éª¤

### åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
mkdir prometheus-grafana && cd prometheus-grafana
```

### ç¼–å†™ docker-compose.yml

```yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ./alert.rules.yml:/etc/prometheus/alert.rules.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--web.enable-lifecycle'
    ports:
      - '9090:9090'
    restart: unless-stopped
    networks:
      - monitoring

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    volumes:
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    ports:
      - '3000:3000'
    restart: unless-stopped
    networks:
      - monitoring

  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml
      - ./email.tmpl:/etc/alertmanager/email.tmpl
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
    ports:
      - '9093:9093'
    restart: unless-stopped
    networks:
      - monitoring

  node_exporter:
    image: prom/node-exporter:latest
    container_name: node_exporter
    ports:
      - '9100:9100'
    restart: unless-stopped
    networks:
      - monitoring

  blackbox_exporter:
    image: prom/blackbox-exporter:latest
    container_name: blackbox_exporter
    ports:
      - '9115:9115'
    restart: unless-stopped
    networks:
      - monitoring

networks:
  monitoring:

volumes:
  grafana-data:
```

### é…ç½® Prometheus

åˆ›å»º `prometheus.yml` æ–‡ä»¶ï¼Œé…ç½®ç›‘æ§ç›®æ ‡å’Œå‘Šè­¦è§„åˆ™æ–‡ä»¶ï¼š

```yml
global:
  scrape_interval: 15s

rule_files:
  - 'alert.rules.yml'

scrape_configs:
  - job_name: 'node_exporter'
    static_configs:
      - targets: ['ä½ çš„AæœåŠ¡å™¨ip:9100', 'ä½ çš„BæœåŠ¡å™¨ip:9100']

  - job_name: 'blackbox'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - image.me.com
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox_exporter:9115
      - source_labels: [__param_target]
        regex: 'image.me.com'
        target_label: webapp
        replacement: 'ç®€å•å›¾åºŠ'

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['ä½ çš„æœåŠ¡å™¨ip:9093']
```

> [!NOTE] **å¦‚æœä½ çš„ web åº”ç”¨æ²¡æœ‰åŸŸåï¼Œå¯ä»¥å°†åŸŸåæ›¿æ¢æˆå®é™…åº”ç”¨çš„ ip+port**

### é…ç½®å‘Šè­¦è§„åˆ™

åœ¨ `alert.rules.yml` ä¸­æ·»åŠ  Web åº”ç”¨çš„å‘Šè­¦è§„åˆ™ï¼š

```yml
groups:
  - name: node_alerts
    rules:
      - alert: HighCPUUsage
        expr: avg(rate(node_cpu_seconds_total{mode!="idle"}[2m])) * 100 > 80
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'High CPU Usage'
          description: 'CPU ä½¿ç”¨ç‡è¶…è¿‡ 80% æŒç»­ 2 åˆ†é’Ÿ'

      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 80
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'High Memory Usage'
          description: 'å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡ 80% æŒç»­ 2 åˆ†é’Ÿ'

      - alert: WebServiceDown
        expr: probe_success == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: 'Web Service Down'
          description: 'Web æœåŠ¡ä¸å¯ç”¨'

      - alert: InstanceDown
        expr: up==0 # up æŒ‡æ ‡ä¸º 0 è¡¨ç¤ºå®ä¾‹å®•æœº
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: 'Instance {{ $labels.instance }} is down'
          description: '{{ $labels.instance }}å·²å®•æœº '
```

### é…ç½® Alertmanager

#### åˆ›å»ºæ¨¡æ¿æ–‡ä»¶

```html
{{ define "email.to.html" }}
{{ range .Alerts }}
=========start==========<br>
å‘Šè­¦ç¨‹åº: <b>Prometheus Alertmanager</b> <br>
å‘Šè­¦çŠ¶æ€ï¼š
<span style="color:{{ if eq .Status "firing" }}red{{ else }}green{{ end }};">
    {{ if eq .Status "firing" }}ğŸ”¥ è§¦å‘ {{ else }}âœ… æ¢å¤ {{ end }}
</span> <br>
å‘Šè­¦çº§åˆ«: <b>{{ .Labels.severity }} çº§</b> <br>
å‘Šè­¦ç±»å‹: <b>{{ .Labels.alertname }}</b> <br>
æ•…éšœä¸»æœº: <b>{{ .Labels.instance }}</b> <br>
å‘Šè­¦ä¸»é¢˜: <b>{{ .Annotations.summary }}</b> <br>
å‘Šè­¦è¯¦æƒ…: {{ .Annotations.description }} <br>
è§¦å‘æ—¶é—´ï¼š<b>{{ (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}</b> <br>
{{ if and (ne .EndsAt.Unix 0) (ne .EndsAt.Year 1) }}
æ¢å¤æ—¶é—´ï¼š<b>{{ (.EndsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}</b> <br>
{{ end }}
=========end==========<br>
{{ end }}
{{ end }}
```

> [!CAUTION]**æ—¶é—´æ ¼å¼åŒ–æŒ‰ç…§ç¤ºä¾‹é‡Œçš„æ ¼å¼å†™ï¼Œå¦åˆ™æ ¼å¼åŒ–ç»“æœä¸æ­£ç¡®**

#### è·å–é‚®ç®±æˆæƒç 

- æ‰“å¼€æ‚¨çš„Googleè´¦æˆ·ã€‚
  - ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’çš„ä¸ªäººå¤´åƒã€‚
  - é€‰æ‹© `ç®¡ç† Google è´¦å·`ã€‚
  - åœ¨å·¦ä¾§å¯¼èˆªæ ä¸­ï¼Œæ‰¾åˆ° `å®‰å…¨æ€§`ã€‚
    ![security](http://image.jxzsite.com/i/2025/03/05/pr065t.png)
- è®¾ç½®åŒé‡éªŒè¯ã€‚
  - åœ¨ `å®‰å…¨æ€§` é¡µé¢ä¸­æ‰¾åˆ° `ä¸¤æ­¥éªŒè¯`ã€‚
  - æŒ‰ç…§å±å¹•æç¤ºè¾“å…¥å¯†ç å¼€å¯åŒé‡éªŒè¯ã€‚
- ç‚¹å‡» [æ­¤é“¾æ¥](https://security.google.com/settings/security/apppasswords) åˆ›å»ºåº”ç”¨å¹¶è·å–æˆæƒç ã€‚
  ![app](http://image.jxzsite.com/i/2025/03/05/pqzy2x.png)

#### åˆ›å»º `alertmanager.yml` é…ç½®æ–‡ä»¶

```yml
global:
  resolve_timeout: 5m
  smtp_from: 'é‚®ä»¶å‘é€åœ°å€'
  smtp_smarthost: 'smtp.gmail.com:465'
  smtp_auth_username: 'é‚®ä»¶å‘é€åœ°å€'
  smtp_auth_password: 'æˆæƒç '
  smtp_require_tls: false
templates:
  - '/etc/alertmanager/email.tmpl'

route:
  group_by: ['alertname']
  group_wait: 5s
  group_interval: 5s
  repeat_interval: 5m
  receiver: 'email'

receivers:
  - name: 'email'
    email_configs:
      - to: 'é‚®ä»¶æ¥æ”¶åœ°å€'
        html: '{{ template "email.to.html" . }}'
        headers: { Subject: 'Prometheus [Warning] å‘Šè­¦é‚®ä»¶' }
        send_resolved: true
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'dev', 'instance']
```

- **smtp_smarthost**ï¼šç”¨äºå‘é€é‚®ä»¶çš„é‚®ç®± SMTP æœåŠ¡å™¨åœ°å€+ç«¯å£ã€‚ï¼ˆæ¯”å¦‚è°·æ­Œé‚®ç®±çš„æ˜¯ï¼šsmtp.gmail.com:465ï¼‰
- **smtp_auth_username**ï¼šä½ è‡ªå·±çš„é‚®ç®±åœ°å€ã€‚
- **headers**ï¼šé‚®ä»¶æ ‡é¢˜ã€‚
- âš ï¸ **smtp_auth_password**ï¼šä¸æ˜¯é‚®ç®±çš„å¯†ç ï¼Œè€Œæ˜¯å‘é€é‚®ç®±çš„æˆæƒç ã€‚
- âš ï¸ **templates**ï¼šå£°æ˜é‚®ä»¶çš„æ¨¡æ¿è·¯å¾„ï¼Œéœ€è¦ä¸ `docker-compose.yml` æ–‡ä»¶ä¸­ `alertmanager` å®¹å™¨æŒ‚è½½çš„è·¯å¾„ä¸€è‡´ã€‚
- **html**ï¼šGo è¯­è¨€çš„ `html/template` æ¨¡æ¿è¯­æ³•ï¼ŒåŒå¼•å·é‡Œçš„å†…å®¹ `email.to.html` å³ä¸ºæ¨¡æ¿åç§°ï¼Œè¦å’Œæ¨¡æ¿æ–‡ä»¶ä¸­å®šä¹‰çš„ä¸€è‡´ã€‚

### å¯åŠ¨æœåŠ¡

```bash
docker-compose up -d
```

## é…ç½® Grafana ä»ªè¡¨ç›˜

- è®¿é—® Grafanaï¼š`http://localhost:3000`ï¼Œé»˜è®¤ç”¨æˆ·åå’Œå¯†ç ä¸º `admin/admin` ã€‚
  ![grafana](http://image.jxzsite.com/i/2025/03/05/qhivvf.png)
- æ·»åŠ  Prometheus æ•°æ®æºï¼š
  ![datasource](http://image.jxzsite.com/i/2025/03/05/s5ziud.png)
- å¯¼å…¥ä»ªè¡¨ç›˜ï¼š
  - Node Exporter Dashboard 20240520 é€šç”¨JOBåˆ†ç»„ç‰ˆï¼ˆID: 16098ï¼‰ï¼šç”¨äºç›‘æ§æœåŠ¡å™¨ä¸»æœºã€‚
  - Blackbox Exporter (HTTP prober)ï¼ˆID: 13659ï¼‰ï¼šç”¨äºç›‘æ§ Web åº”ç”¨çš„å¯ç”¨æ€§ã€‚
    ![id1](http://image.jxzsite.com/i/2025/03/05/qmsxxd.png)
    ![id2](http://image.jxzsite.com/i/2025/03/05/qm0ipw.png)

## éªŒè¯ç›‘æ§

- æœåŠ¡å™¨ç›‘æ§ï¼šè®¿é—® Grafanaï¼ŒæŸ¥çœ‹ Node Exporter ä»ªè¡¨ç›˜ï¼Œç¡®è®¤æœåŠ¡å™¨æŒ‡æ ‡æ­£å¸¸ã€‚
  ![server](http://image.jxzsite.com/i/2025/03/05/qtp87o.png)

- Web åº”ç”¨ç›‘æ§ï¼šè®¿é—® Grafanaï¼ŒæŸ¥çœ‹ Blackbox Exporter ä»ªè¡¨ç›˜ï¼Œç¡®è®¤ Web åº”ç”¨çš„å¯ç”¨æ€§ã€‚
  ![web](http://image.jxzsite.com/i/2025/03/05/qtp4w4.png)

## å‘Šè­¦é€šçŸ¥

åœæ­¢ web æœåŠ¡ï¼ŒéªŒè¯æ˜¯å¦æ”¶åˆ°å‘Šè­¦é‚®ä»¶ã€‚

```bash
docker stop webæœåŠ¡id
```

- æµè§ˆå™¨è®¿é—® Prometheus ç®¡ç†ç•Œé¢å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š
  ![PENDING](http://image.jxzsite.com/i/2025/03/05/slrbeg.png)

  - ç»¿è‰²ï¼šè¡¨ç¤ºæ­£å¸¸ã€‚
  - é»„è‰²ï¼šPENDING è¡¨ç¤ºå‘Šè­¦è¿˜æ²¡æœ‰å‘é€åˆ° Alertmanager ï¼Œå› ä¸º `rules` é‡Œé¢é…ç½®äº† `for: 30s`ã€‚
    30ç§’åçŠ¶æ€ç”± PENDING å˜ä¸º FIRING ï¼Œæ­¤æ—¶ Prometheus æ‰å°†å‘Šè­¦å‘ç»™ Alertmanager ï¼ŒåŒæ—¶æ‰“å¼€ Alertmanager ç•Œé¢å¯ä»¥çœ‹åˆ°æœ‰ä¸€æ¡æ–°çš„å‘Šè­¦äº§ç”Ÿã€‚
    ![FIRING](http://image.jxzsite.com/i/2025/03/05/slzzre.png)
    ![Alertmanager](http://image.jxzsite.com/i/2025/03/05/sm0b3w.png)

- æŸ¥çœ‹å‘Šè­¦é‚®ä»¶
  ![email](http://image.jxzsite.com/i/2025/03/05/r989o3.png)

## æ€»ç»“

é€šè¿‡ Docker Composeï¼Œæˆ‘ä»¬å¿«é€Ÿéƒ¨ç½²äº† Prometheusã€Grafana å’Œ Alertmanagerï¼Œå®ç°äº†æœåŠ¡å™¨å’Œ Web åº”ç”¨çš„ç›‘æ§ä¸å‘Šè­¦ã€‚è¿™ç§æ–¹æ¡ˆå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- å¿«é€Ÿéƒ¨ç½²ï¼šä½¿ç”¨ Docker Compose ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚

- çµæ´»æ‰©å±•ï¼šå¯ä»¥è½»æ¾æ·»åŠ æ–°çš„ç›‘æ§ç›®æ ‡æˆ–å‘Šè­¦è§„åˆ™ã€‚

- å¯è§†åŒ–å¼ºå¤§ï¼šGrafana æä¾›äº†ä¸°å¯Œçš„å›¾è¡¨å’Œä»ªè¡¨ç›˜åŠŸèƒ½ã€‚

å¸Œæœ›æœ¬æ–‡èƒ½å¸®åŠ©ä½ æ„å»ºä¸€ä¸ªé«˜æ•ˆçš„ç›‘æ§ç³»ç»Ÿï¼å¦‚æœæœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®ºã€‚

Happy monitoring! <Twemoji emoji="clinking-beer-mugs" />
